name: Translate New and Modified Posts

on:
  push:
    paths:
      - 'site/content/es/posts/**'

jobs:
  translate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 2

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install -r aphra/requirements.txt

    - name: Create config.toml
      run: |
        echo '[openrouter]' > aphra/config.toml
        echo 'api_key = "${{ secrets.API_KEY_OPENROUTER }}"' >> aphra/config.toml
        echo '' >> aphra/config.toml
        echo '[llms]' >> aphra/config.toml
        echo 'writer = "anthropic/claude-3.5-sonnet:beta"' >> aphra/config.toml
        echo 'searcher = "perplexity/llama-3-sonar-large-32k-online"' >> aphra/config.toml
        echo 'critiquer = "anthropic/claude-3.5-sonnet:beta"' >> aphra/config.toml

    - name: Identify new or modified posts
      id: changes
      run: |
        git diff --name-only --diff-filter=AMR HEAD^ HEAD | tr -d '"' | grep "^site/content/es/posts/" | grep "index.md$" | sed 's/^/"/; s/$/"/' > modified_files.txt || true
        if [ -s modified_files.txt ]; then echo "changes_detected=true" >> $GITHUB_OUTPUT; else echo "changes_detected=false" >> $GITHUB_OUTPUT; fi

    - name: Translate posts
      if: steps.changes.outputs.changes_detected == 'true'
      run: |
        cat modified_files.txt | python -c "
          import sys
          import os
          import urllib.parse
          
          def decode_path(path):
              return urllib.parse.unquote(path)
          
          files = sys.stdin.read().splitlines()
          
          for file in files:
              file = decode_path(file.strip().strip('\"'))
          
              folder = os.path.dirname(file)
              folder_name = os.path.basename(folder)
              post_name = os.path.basename(folder_name)
          
              dest_dir = f'site/content/en/posts/{post_name}'
              os.makedirs(dest_dir, exist_ok=True)
          
              for item in os.listdir(folder):
                  s = os.path.join(folder, item)
                  d = os.path.join(dest_dir, item)
                  if os.path.isdir(s):
                      shutil.copytree(s, d, dirs_exist_ok=True)
                  else:
                      shutil.copy2(s, d)
          
              os.system(f'python translate_runner.py aphra/config.toml Spanish English \"{file}\" \"{dest_dir}/index.md\"')
          "

    - name: Commit changes
      if: steps.changes.outputs.changes_detected == 'true'
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add site/content/en/posts/
        git commit -m "Translated new/modified posts using Aphra"
        git push
